---
title: "CS1NBartholowMSDS6306"
author: "Nicole Bartholow"
date: "9/30/2018"
output: 
  html_document:
      keep_md:  true
---

```{r Setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(plyr)
library(ggplot2)
library(openintro)
library(reshape2)
library(maps)
library(mapproj)
library(gridExtra)
library(grid)
library(curl)
library(kableExtra)
library(formattable)
```

#Introduction
###The next great revolution in beer is coming from the largest brewer in the world. That's nothing new.  Our introduction of Bud Light in 1982, started as our answer to Miller Light. Bud Light quickly became the best selling beer in America and one of the best selling beers in the world. A-B InBev has developed cutting edge brewing from our history of serving a changing market, specifically, making current offerings less caloric and less alcoholic. Our newest process to produce a great-tasting, low-alcohol beer that mimics the original beer has surprised even us.  Simply speaking, it's a breakthrough in flavor authenticity while reducing alcohol content to a range of 0.0 to <0.5%.  Our initial product offering mimicing our flagship beer, Budweiser, has met with great reviews. We are well positioned to surpass our 2015 corporate goal of transitioning 20% of our global beer volume to zero or near-zero ABV by 2025. Our proposal today focuses on the opportunity: "This new process is repeatable for many beers. How do we use it to tap into the markets where we have stalled."    
###We've watched the craft brew market gain momentum over the last 20 years, with the number of craft breweries increase eight-fold.  The national market for these beers continues to rise and millinal preference for for these beer styles remains strong.  One style in particular, India Pale Ale, dominates as the most popular craft beer style. The IPA is particularly well-suited to our process for several reasons, the bitter taste profile, the traditionally-high alcohol content, the millenial (and global) trend for low- or no-alcohol beverages.
###The current population data of craft breweries and beers provided for analysis contains 551 craft breweries producing 2410 beers within the United States.  The following is a summary analysis of the market based on that data and recommendations for next steps in entering that market.
```{r Read Breweries and read Beers files into dataframes}
#set working directory for local computer
#REPRODUCIBLE TIP - CHANGE THIS WORKING DIRECTORY FOR YOUR REPRODUCTION ENVIRONMENT
setwd("/Users/nicolealphin/Desktop/DataScience/MSDS6306-DoingDataScience/HW/CaseStudy1")
Breweries <- read.csv("./Analysis/Data/Breweries.csv", header=TRUE) #import Breweries.csv file into Breweries dataframe
Beers <- read.csv("./Analysis/Data/Beers.csv", header=TRUE) #import Beers.csv file into Beers dataframe

#clean up state abbr and add state names
Breweries$State<-trimws(Breweries$State) #trim leading white space from State Abbreviations
Breweries$StateName <- state.name[match(Breweries$State,state.abb)] #add State Name from State Abbr for table - excludes DC
Breweries[is.na(Breweries)] <- "Washington DC" #assign State Name for Washington DC
Breweries$StateName <- as.factor(Breweries$StateName) #assign State as a factor to facilitate Summary Statistics
```

##How many Breweries are present in each state?
```{r Brewery count per state}
BreweryCount <- data.frame(sort(table(Breweries$StateName), decreasing=TRUE)) #number of Breweries in each state
colnames(BreweryCount)<- c("State", "NumberOfBreweries") #assign meaningful column name to Brewery Count for output
#write("Number of Breweries in Each State", file ="")
BreweryCountHead <- head(BreweryCount, 15) #Does this need to be full list or can it be half the list
```
###Our data showed the number of breweries per state ranges from a max of 47 in Colorado, to 1 per state in the bottom 4 states. 
###The median number of breweries per state is 7.


```{r Heat Map for Brewery Count}
#set states to lower case
BreweryCountM <- BreweryCount
BreweryCountM$region <- tolower(BreweryCountM$State)
#BreweryCountM = BreweryCountM[-c(2,11),] #remove Hawaii and Alaska
states <- map_data("state")
BrewCountMap <- merge(states, BreweryCountM, by="region")
BrewCountMap <- BrewCountMap[order(BrewCountMap$order),] #order the list so the map is drawn correctly
map1 <- ggplot(BrewCountMap, aes(long, lat)) + geom_polygon(aes(group=group, fill=NumberOfBreweries)) 
map1 + coord_map("polyconic") + scale_fill_gradientn(colours=rev(heat.colors(10)),na.value="grey90") +ggtitle("Number of Breweries in Each Mainland State, fig. 1")+ theme_bw()
```

###Number of Breweries in Top 15 States
```{r Summary of Brewery Data}
write("Breweries in Each State, table 1", file ="")
BreweryCountHead %>%
  kable() %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

#write("Summary Statistics: Breweries in Each State, fig. 2", file ="")
ggplot(BreweryCount, aes(x=1, y=NumberOfBreweries)) + geom_boxplot() + scale_x_continuous(breaks=NULL) +theme(axis.title.x = element_blank()) + ggtitle("Summary Statistics: Breweries in Each State, fig.2")

MinBrew <- min(BreweryCount$NumberOfBreweries) # minimum 1/state
MaxBrew <- max(BreweryCount$NumberOfBreweries) #maximum 47/state
MedianBrew <- median(BreweryCount$NumberOfBreweries) #median 7 breweries/state
```

#Merge Beers and Breweries dataframes 
```{r Merge Breweries and Beers dataframes by Brewery ID}
#Combine Breweries and Beers dataframes on their common column, Brewery_ID/Brew_ID
BeerBreweries <- merge(x = Breweries, y = Beers, by.x=c("Brew_ID"), by.y =c("Brewery_id"), all=FALSE)
identical(nrow(Beers),nrow(BeerBreweries)) #confirm number of rows remains constant from Beers to Beer Breweries to verify merge
colnames(BeerBreweries) <- c("BreweryID","BreweryName","City","State","StateName","BeerName","BeerID","ABV","IBU","Style","Ounces") #Update column names for clarification


BeerBreweries <- BeerBreweries[order(BeerBreweries$BeerID),]
BBHead <- head(BeerBreweries, 6) #create dataframe of first 6 rows
BBTail <- tail(BeerBreweries, 6) #create dataframe of last 6 rows
BBGraph <- rbind(BBHead,BBTail) #combine dataframes for presentation
BBGraph %>%
  kable() %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```


#Number of Beers Produced by Each Brewery
```{r Size of Breweries}
#Size of Breweries - how many beers do these breweries produce
BeerCount <- data.frame(sort(table(BeerBreweries$BreweryName), decreasing=TRUE))
colnames(BeerCount)<- c("BreweryName", "NumberOfBeers")
#write("Number of Beers per Brewery", file ="")
SumBeers <- summary(BeerCount$NumberOfBeers)
#SumBeers <- round(SumBeers, digits = 1)
# median 3, mean 4.4, min 1, max 62
#do a barplot
ggplot(BeerCount, aes(x=1, y=NumberOfBeers)) + geom_boxplot() + scale_x_continuous(breaks=NULL) + theme(axis.title.x = element_blank())+ ggtitle("Summary Statistics: Number of Beers Produced by Brewery")
```

#Missing Data Analysis
```{r get number of NAs in each column, include = TRUE}
#Count the number of NAs in each column
EmptyCols <- colSums(is.na(BeerBreweries))
grid.table(EmptyCols)

EmptyCols <- EmptyCols[EmptyCols !=0]

EmptyCols %>%
  kable() %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

BeerBreweriesNA <- BeerBreweries[is.na(BeerBreweries$ABV == "NA"),]
#Everything with no ABV also has no IBU
BeerBreweriesNoNA <- BeerBreweries[!is.na(BeerBreweries$ABV == "NA"),]
```
### There are 62 beers missing both the ABV measurement and IBU measurements.
### There are an additional 943  beers missing the IBU measurement.
### There are no other missing data points in the dataframe


#IPA & Varietals Market Share
```{r Brew Style Analysis}
BeerBreweries$FacStyle <- BeerBreweries$Style
#Assign meaning style factors only if beers of that style > 50, all others assigned to other
#10 style > 50, 90 styles <50
Styles <- c("American IPA","American Pale Ale (APA)", "American Amber / Red Ale", "American Amber / Red Lager", "American Blonde Ale", "American Double / Imperial IPA", "American Pale Wheat Ale", "American Brown Ale", "American Porter", "Saison / Farmhouse Ale","Witbier")
StylesF <- c("American/Double/Iperial IPA","American Pale Ale (APA)", "American Amber / Red Ale", "American Amber / Red Ale", "American Blonde Ale", "American/Double/Iperial IPA", "American Pale Wheat Ale", "American Brown Ale", "American Porter", "Saison / Farmhouse Ale","Witbier")

BeerBreweries$FacStyle = factor(BeerBreweries$FacStyle, levels=Styles, labels = StylesF) #assign relevant styles
#group small styles
BeerBreweries$FacStyle <- as.character(BeerBreweries$FacStyle)
BeerBreweries$FacStyle[!(BeerBreweries$FacStyle %in% StylesF)] = "Other"
BeerBreweries$FacStyle <- as.factor(BeerBreweries$FacStyle)

StyleCount <- data.frame(sort(table(BeerBreweries$FacStyle), decreasing=TRUE))
colnames(StyleCount)<- c("Style", "NumberOfBeers")
#write("Number of Beers per Style", file ="")
SumStyles <- summary(StyleCount$NumberOfBeers)
SumStyles <- round(SumStyles, digits = 1)

ggplot(StyleCount, aes(Style, NumberOfBeers, fill=Style)) + geom_bar(stat = "identity") + ggtitle("Total Beers Produced by Style") + theme(legend.position = "none", axis.text.x=element_text(angle = 90,vjust = 0), plot.title = element_text(hjust = 0.5)) + ylab("Total Beers by Style")
```

```{r IBU Comparison between IPA and Other Varieties}
#all non IPA beers into one list
OtherBeers <- BeerBreweries[-grep("IPA|India", BeerBreweries$Style), ]
j <- ggplot(OtherBeers, aes(x=IBU)) + geom_histogram(position = "identity")
j + geom_histogram(position = "identity", binwidth = 8, fill="yellow", colour = "red")+ ggtitle("IBU Distribution for non-IPA Varietals")

#IPA list only - 574 total, 395 have IBU data, 
BigIPA <- BeerBreweries[grep("IPA|India", BeerBreweries$Style), ]
IPAwIBU <- BigIPA[!is.na(BigIPA$IBU),]
summary(BigIPA)
str(BigIPA)
h <- ggplot(IPAwIBU, aes(x=IBU)) + geom_histogram(position = "identity")
h + geom_histogram(position = "identity", binwidth = 8, fill="yellow", colour = "red")+ ggtitle("IBU Distribution for IPA Varietals")


#All IPA and All APA
BigAIPA <- BeerBreweries[grep("IPA|India|APA", BeerBreweries$Style), ]
summary(BigAIPA)
str(BigAIPA)

#APA only list
APA <- BigAIPA[which(BigAIPA$Style == "American Pale Ale (APA)"),]
summary(APA)
str(APA)

#APA with IBU > 40 
APA40 <- BigAIPA[which(BigAIPA$IBU>40 & BigAIPA$Style == "American Pale Ale (APA)"),]
summary(APA40)
str(APA40)
```

```{rNumber of Breweries producing a single beer and percentage IPA}
SmallBrews <- count(BeerCount$NumberOfBeers == 1)
#120 true, 431 false
#120 of 558 breweries are only brewing 1 beer

SmallBrews <- BeerCount[BeerCount$NumberOfBeers == 1,]
SmallBeers <- merge(SmallBrews, BeerBreweries, "BreweryName", all=FALSE)
SmallIPA <- SmallBeers[grep("IPA|India|APA", SmallBeers$Style), ]
#Of the 120 Breweries producing only one beer, 50 of those beers are IPA or IPA varietal
```




#Median ABV and IBU by State
```{r Create Barcharts of IBU and ABV by State}
#create vectors of medians by state for measurements of interest ABV and IBU
attach(BeerBreweries) #attaching dataset here alleviates error, even though I had the dataset name in the following calls
ABVMedians <- aggregate(ABV ~ StateName, data=BeerBreweries, median) #calculate median ABV by state
IBUMedians <- aggregate(IBU ~ StateName, data=BeerBreweries, median) #calculate median IBU by state
#ordered Barchart of Median Alcohol Content by State
ggplot2::ggplot(ABVMedians, aes(x=reorder(StateName, -ABV), y=ABV, fill=StateName)) + geom_bar(stat = "identity") + ggtitle("Median Alcohol by Volume by State") + theme(legend.position = "none", axis.text.x=element_text(angle = 90,vjust = 0), plot.title = element_text(hjust = 0.5)) + xlab("State") + ylab("Median ABV")
#+ scale_fill_hue(l=40, c=100)
#ordered Barchart of Median Bitterness by State
ggplot2::ggplot(IBUMedians, aes(x=reorder(StateName, -IBU), y=IBU, fill=StateName)) + geom_bar(stat = "identity") + ggtitle("Median IBU by Volume by State") + theme(legend.position = "none", axis.text.x=element_text(angle = 90,vjust = 0), plot.title = element_text(hjust = 0.5)) + xlab("State") + ylab("Median IBU") 
#+ scale_fill_hue(l=40, c=100)
```
###We expect medians to be more consistent since they are an accumulation of values.  
###Median ABV is relatively consistent across states, with a range of 4% to 6.25%, and a median of 5.6%.
###On the other hand, Median IBU has a relatively broad range, with a range of 19-61 units, and a median of 35 units.  This reflects the extremely broad range of the individual beers, which is due to style variety.  Fermentation has traditionally produced a consistent product, but taste is refined more broadly.


#Which states produce the most alcoholic beer?  Which states produce the most bitter beer?
```{r}
#convert column state name to character for which.max
#get the state with the highest median IBU and ABV
IBUMedians$StateName <- as.character(IBUMedians$StateName)
ABVMedians$StateName <- as.character(ABVMedians$StateName)
StateMaxMedABV <- ABVMedians$StateName[which.max(ABVMedians$MedianABVPC)]
StateMaxMedIBU <- IBUMedians$StateName[which.max(IBUMedians$MedianIBU)]
#convert state name column to character for which.max
#get the state that produces the beers with the highest individual IBU and ABV
BeerBreweries$StateName <- as.character(BeerBreweries$StateName)
StateMaxABV <- BeerBreweries$StateName[which.max(BeerBreweries$ABV)]
StateMaxIBU <- BeerBreweries$StateName[which.max(BeerBreweries$IBU)]
```
###Colorado produces the beer with the single highest ABV, at 12.8%.  
###Kentucky and Washington DC produce the highest median ABV at 6.25%. 
###Oregon produces the bitterest single beer, at 138 IBU.
###Maine produces the highest median IBU beers, at 35 units.

#Summary Statistics for Alcohol by Volume (ABV)
```{r}
#summary statistics for ABV Alcohol by Volume
SummaryABV <- summary(BeerBreweries$ABV)
ggplot(BeerBreweries, aes(x=1, y=ABV)) + geom_boxplot() + scale_x_continuous(breaks=NULL) + theme(axis.title.x = element_blank())+ ggtitle("Summary Statistics: Alcohol by Volume")
```
##Digging into ABV, Beers in our study range in ABV from 0.1% to 12.8%, with 75% of beers falling between 5% and 6.7%.  The median ABV for the beers in our study is 5.6%.


#Question 7
```{r IBU ABV Correlation}
ggplot(BeerBreweries, aes(ABV, IBU)) + geom_point() + ggtitle("IBU - ABV Correlation")

IBU.ABV <- lm(Beers$ABV ~ Beers$IBU, data=Beers)
summary(IBU.ABV)

cor(Beers$ABV, Beers$IBU, use = "complete.obs")

cor(BigIPA$ABV, BigIPA$IBU, use = "complete.obs")

```



## Upload to Github 
###a. Push at minimum your RMarkdown for this homework assignment and a Codebook to one of your GitHub repositories (you might place this in a Homework repo like last week).  The Codebook should contain a short definition of each object you create, and if creating multiple files, which file it is contained in.  You are welcome and encouraged to add other filesâ€”just make sure you have a description and directions that are helpful for the grader.
### I looked up several codebooks, and wasn't sure if I should also describe the input files, the intermediate objects, etc. I appreciate any and all feedback!

###https://github.com/NicoleABartholow/MSDS6306CaseStudy1



